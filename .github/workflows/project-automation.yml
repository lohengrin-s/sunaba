# .github/workflows/project-automation.yml
name: Move Issue in Project (Org Project v2)

on:
  issues:
    types: [opened, labeled, edited, reopened]

jobs:
  move-issue:
    runs-on: ubuntu-latest
    environment: ActionsSecret
    if: |
      contains(github.event.issue.labels.*.name, 'üÜï ËøΩÂä†‰∫àÂÆö') ||
      contains(github.event.issue.labels.*.name, '‚öô ÂÆüË£Ö‰∏≠') ||
      contains(github.event.issue.labels.*.name, 'üöÄ „É™„É™„Éº„ÇπÊ∏àÔºàOFFÔºâ') ||
      contains(github.event.issue.labels.*.name, 'üü¢ ONÈÅãÁî®‰∏≠') ||
      contains(github.event.issue.labels.*.name, 'üßπ ÂâäÈô§‰∫àÂÆö') ||
      contains(github.event.issue.labels.*.name, '‚úÖ ÂâäÈô§ÂÆå‰∫Ü')
    steps:
      - name: Generate GitHub App Token
        id: generate-github-app-token
        uses: actions/create-github-app-token@v1
        with:
          app_id: ${{ secrets.ISSUE_IN_PROJECT_TOOL_APP_ID }} # GitHub App„ÅÆID
          private_key: ${{ secrets.ISSUE_IN_PROJECT_TOOL_PRIVATE_KEY }} # GitHub App„ÅÆÁßòÂØÜÈçµ

      - name: Get Issue Labels
        id: get_labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);
            console.log('labels:', labels);
            core.setOutput('labels', labels.join(','));

      - name: Get Org Project v2 Node ID from project number
        id: get_project_id
        env:
          GITHUB_TOKEN: ${{ steps.generate-github-app-token.outputs.token }}
        run: |
          ORG="lohengrin-s" # ‚ÜêOrganizationÂêç„Å´ÁΩÆ„ÅçÊèõ„Åà
          PROJECT_NUMBER=1    # ‚ÜêURL„ÅÆÊú´Â∞æ„ÅÆÊï∞ÂÄ§„Å´ÁΩÆ„ÅçÊèõ„Åà
          PROJECT_ID=$(gh api graphql -f query='query { organization(login: "'$ORG'") { projectV2(number: '$PROJECT_NUMBER') { id } } }' --jq ".data.organization.projectV2.id")
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT

      - name: Get Status Field ID and Option IDs
        id: get_status_fields
        env:
          GITHUB_TOKEN: ${{ steps.generate-github-app-token.outputs.token }}
        run: |
          ORG="lohengrin-s"
          PROJECT_ID="${{ steps.get_project_id.outputs.project_id }}"
          # Status„Éï„Ç£„Éº„É´„ÉâID„Å®ÂêÑoptionId„ÇíÂèñÂæó
          gh api graphql -F projectId=$PROJECT_ID -f query='query($projectId: ID!) { node(id: $projectId) { ... on ProjectV2 { fields(first: 50) { nodes { ... on ProjectV2SingleSelectField { id name options { id name } } } } } } }' > fields.json
          STATUS_FIELD_ID=$(jq -r '.data.node.fields.nodes[] | select(.name=="Status") | .id' fields.json)
          echo "status_field_id=$STATUS_FIELD_ID" >> $GITHUB_OUTPUT
          # ÂêÑ„É©„Éô„É´Âêç‚ÜíoptionId„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÂá∫Âäõ
          jq -r '.data.node.fields.nodes[] | select(.name=="Status") | .options[] | "option_id_" + (.name|gsub("[ -]";"_")) + "=" + .id' fields.json >> $GITHUB_OUTPUT

      - name: Add Issue to Org Project v2
        env:
          GITHUB_TOKEN: ${{ steps.generate-github-app-token.outputs.token }}
        run: |
          PROJECT_ID="${{ steps.get_project_id.outputs.project_id }}"
          CONTENT_ID="${{ github.event.issue.node_id }}"
          ADD_ITEM_RESULT=$(gh api graphql -F projectId=$PROJECT_ID -F contentId=$CONTENT_ID -f query='mutation($projectId:ID!, $contentId:ID!) { addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) { item { id } } }')
          echo "[DEBUG] addProjectV2ItemById result: $ADD_ITEM_RESULT"

      - name: Set Project Status via GraphQL
        env:
          GITHUB_TOKEN: ${{ steps.generate-github-app-token.outputs.token }}
        run: |
          LABELS="${{ steps.get_labels.outputs.labels }}"
          PROJECT_ID="${{ steps.get_project_id.outputs.project_id }}"
          STATUS_FIELD_ID="${{ steps.get_status_fields.outputs.status_field_id }}"
          # „É©„Éô„É´Âêç‚ÜíoptionId„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞
          declare -A OPTION_IDS
          # jq„ÅßÂá∫Âäõ„Åó„Åüoption_id_„É©„Éô„É´Âêç=ID„ÇíË™≠„ÅøËæº„ÇÄ
          while IFS== read -r key value; do
            if [[ $key == option_id_* ]]; then
              label=${key#option_id_}
              OPTION_IDS[$label]=$value
            fi
          done < <(env)
          echo "=== OPTION_IDS„ÅÆÂÜÖÂÆπ ==="
          for key in "${!OPTION_IDS[@]}"; do
            echo "label: $key ‚Üí optionId: ${OPTION_IDS[$key]}"
          done
          echo "======================="
          echo "=== „É©„Éô„É´„Å®optionId„ÅÆÂØæÂøú ==="
          for label in $(echo $LABELS | tr ',' ' '); do
            label_key=$(echo $label | tr ' ' '_' | tr '-' '_')
            echo "label: $label_key ‚Üí optionId: ${OPTION_IDS[$label_key]}"
          done
          echo "==========================="
          # ÊúÄÂàù„Å´‰∏ÄËá¥„Åó„Åü„É©„Éô„É´„ÅÆoptionId„Çí‰Ωø„ÅÜ
          OPTION_ID=""
          for label in $(echo $LABELS | tr ',' ' '); do
            label_key=$(echo $label | tr ' ' '_' | tr '-' '_')
            if [[ -n "${OPTION_IDS[$label_key]}" ]]; then
              OPTION_ID="${OPTION_IDS[$label_key]}"
              break
            fi
          done
          if [[ -z "$OPTION_ID" ]]; then
            echo "No matching optionId for labels: $LABELS"
            exit 0
          fi
          CONTENT_ID="${{ github.event.issue.node_id }}"
          # itemIdÂèñÂæó
          ITEM_ID=$(gh api graphql -F projectId=$PROJECT_ID -f query='query($projectId: ID!) { node(id: $projectId) { ... on ProjectV2 { items(first: 100) { nodes { id content { ... on Issue { id } ... on PullRequest { id } } } } } } }' --jq ".data.node.items.nodes[] | select(.content.id==\"$CONTENT_ID\") | .id")
          if [[ -z "$ITEM_ID" ]]; then
            echo "itemId not found for contentId: $CONTENT_ID"
            exit 0
          fi
          # GraphQL mutation„ÅßStatusÊõ¥Êñ∞
          gh api graphql -F projectId=$PROJECT_ID -F itemId=$ITEM_ID -F fieldId=$STATUS_FIELD_ID -F optionId=$OPTION_ID -f query='mutation($projectId:ID!, $itemId:ID!, $fieldId:ID!, $optionId: String!) { updateProjectV2ItemFieldValue(input: { projectId: $projectId, itemId: $itemId, fieldId: $fieldId, value: { singleSelectOptionId: $optionId } }) { projectV2Item { id } } }'

      - name: Debug LABELS
        run: echo "LABELS=${{ steps.get_labels.outputs.labels }}"
