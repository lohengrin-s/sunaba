# .github/workflows/project-automation.yml
name: Move Issue in Project

on:
  issues:
    types: [opened, labeled, edited, reopend]

jobs:
  move-issue:
    runs-on: ubuntu-latest
    environment: ActionsSecret
    steps:
      - name: Move issue to appropriate project column
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.API_TOKEN }}
          script: |
            const label = context.payload.label.name;
            const issue = context.payload.issue;

            // Project board IDとColumn IDの定義（手動で取得必要）
            const PROJECT_ID = "PVT_kwHOAGqg_84A5tL2";
            const COLUMNS = {
              "feature-flag": "f75ad846",
              "impl-in-progress": "61e4505c",
              "released-off": "47fc9ee4",
              "flag-on": "df73e18b",
              "removal-scheduled": "98236657",
              "flag-removed": "5f605485"
            };

            const columnId = COLUMNS[label];
            if (!columnId) {
              console.log(`ラベル "${label}" に対応するカラムがありません`);
              return;
            }

            // 対象IssueをProjectに追加してカラム移動
            const projects = await github.rest.projects.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const cards = await github.rest.projects.listCards({
              column_id: columnId,
              per_page: 100
            });

            const cardExists = cards.data.some(card => card.content_url?.endsWith(`/issues/${issue.number}`));
            if (!cardExists) {
              await github.rest.projects.createCard({
                column_id: columnId,
                content_id: issue.id,
                content_type: "Issue"
              });
              console.log(`Issue #${issue.number} をカラムに追加`);
            } else {
              console.log(`Issue #${issue.number} はすでにこのカラムに存在します`);
            }
